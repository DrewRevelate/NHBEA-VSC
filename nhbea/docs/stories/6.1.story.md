# Story 6.1: Conference Data Model Unification and Runtime Validation

## Status
Draft

## Story
**As a** Backend Developer,
**I want** to consolidate the conflicting conference data models and implement comprehensive runtime validation with Zod schemas,
**so that** we have a single, consistent, and type-safe data structure across the entire application with proper validation and error handling.

## Acceptance Criteria
1. The conflicting Conference interfaces in `/src/types/conference.ts` and `/src/types/dataModels.ts` are consolidated into a single, comprehensive data model that supports all current and future requirements
2. Complete Zod schema validation is implemented for all conference-related data structures including Conference, Registrant, ConferenceSession, ConferenceSpeaker, and all supporting types
3. Runtime validation is integrated into all data access methods in `/src/lib/conference.ts` with proper error handling and type coercion
4. Database repository methods are updated to use the unified data model with consistent create, update, and query operations
5. All existing components and pages are migrated to use the unified Conference interface without breaking changes
6. Comprehensive unit tests are implemented to validate schema validation, data transformation, and error handling scenarios
7. Migration utilities are provided to transform any existing production data to the new unified schema format
8. TypeScript compilation succeeds without errors and all existing functionality remains intact

## Tasks / Subtasks
- [ ] Analyze and consolidate conflicting data models (AC: 1)
  - [ ] Compare Conference interface in `/src/types/conference.ts` with `/src/types/dataModels.ts` to identify conflicts and overlaps
  - [ ] Identify all conference-related types across the codebase including enhanced features (agenda, speakers, FAQs, venue details)
  - [ ] Create unified Conference interface that combines the best aspects of both existing models
  - [ ] Remove deprecated or redundant fields while maintaining backward compatibility for V1 data
  - [ ] Document the unified schema with clear field descriptions and usage guidelines
  - [ ] Create migration mapping from old interfaces to the new unified interface
- [ ] Implement comprehensive Zod schema validation (AC: 2)
  - [ ] Create ConferenceSchema with all required and optional fields, proper date handling, and nested object validation
  - [ ] Create RegistrantSchema with participant information validation, payment status checks, and preference handling
  - [ ] Create ConferenceSessionSchema for agenda validation with proper time range checks and speaker references
  - [ ] Create ConferenceSpeakerSchema with bio validation, URL validation, and expertise arrays
  - [ ] Create supporting schemas for VenueDetails, AccessibilityInfo, ParkingInfo, AccommodationInfo, and TransportationInfo
  - [ ] Implement SocialMediaConfigSchema and ConferenceThemeSchema for enhanced features
  - [ ] Create comprehensive validation error messages with field-specific guidance
  - [ ] Add schema version tracking for future migration support
- [ ] Integrate runtime validation into data access layer (AC: 3)
  - [ ] Update `/src/lib/conference.ts` methods to use Zod schema validation on all input data
  - [ ] Implement proper error handling with ValidationError class for schema failures
  - [ ] Add data coercion for date strings, numbers, and boolean values from Firestore
  - [ ] Create validation utilities for partial updates and optional field handling
  - [ ] Implement server-side validation for all conference-related API endpoints
  - [ ] Add validation logging for debugging and monitoring schema issues
- [ ] Update database repository methods (AC: 4)
  - [ ] Modify `createConference()` method to validate input data against ConferenceSchema
  - [ ] Update `updateConference()` method with partial validation and merge logic
  - [ ] Enhance `getConference()` method to validate output data and handle schema evolution
  - [ ] Update registrant methods (`createRegistrant`, `updateRegistrant`) with proper validation
  - [ ] Implement batch validation for conference session and speaker data operations
  - [ ] Add query methods with runtime validation for complex conference data retrieval
  - [ ] Create utility methods for safe data transformation between schema versions
- [ ] Migrate existing components and pages (AC: 5)
  - [ ] Update `/src/app/conference/page.tsx` to use unified Conference interface
  - [ ] Modify ConferenceRegistrationForm components to work with validated data structures
  - [ ] Update ConferenceTheme, ConferenceAgenda, and SpeakersSection components
  - [ ] Ensure VenueInformation and ConferenceFAQ components use proper type definitions
  - [ ] Update SocialMediaFeed component to use validated SocialMediaConfig schema
  - [ ] Modify conference-related utility functions and helper methods
  - [ ] Test all component prop types and ensure TypeScript compatibility
- [ ] Implement comprehensive unit tests (AC: 6)
  - [ ] Create test suite for ConferenceSchema validation with valid and invalid data scenarios
  - [ ] Test RegistrantSchema validation including edge cases for guest registration and member references
  - [ ] Create tests for ConferenceSessionSchema with time validation and speaker reference checks
  - [ ] Test schema coercion for dates, numbers, and nested objects from Firestore format
  - [ ] Create integration tests for repository methods with schema validation
  - [ ] Test error handling scenarios and ValidationError response formats
  - [ ] Create performance tests for schema validation with large conference data sets
- [ ] Create migration utilities and documentation (AC: 7)
  - [ ] Create migration script to transform existing conference data to unified schema
  - [ ] Implement data validation and error reporting for migration process
  - [ ] Create rollback utilities in case migration needs to be reversed
  - [ ] Document schema changes and migration steps for production deployment
  - [ ] Create validation utilities for production data health checks
  - [ ] Implement data migration logging and progress tracking
- [ ] Ensure TypeScript compilation and functionality (AC: 8)
  - [ ] Run TypeScript compilation and resolve all type errors related to Conference interface changes
  - [ ] Update import statements and type exports across all files using conference types
  - [ ] Test all existing conference-related functionality to ensure no breaking changes
  - [ ] Verify that enhanced features (agenda, speakers, themes) work with unified schema
  - [ ] Run comprehensive end-to-end tests on conference registration and display flows
  - [ ] Validate that all conference-related API endpoints function correctly with new validation

## Dev Notes

### Previous Story Insights
Building upon the comprehensive Epic 5 site structure audit that identified inconsistencies in data handling patterns across pages. The data model unification effort addresses one of the critical architectural issues identified: conflicting Conference interfaces that create type safety problems and maintenance overhead.

### Current Data Model Conflicts Identified

[Source: /src/types/conference.ts vs /src/types/dataModels.ts]

**Primary Conflicts**:
- **Date Handling**: `/src/types/conference.ts` uses `Date` objects while `/src/types/dataModels.ts` uses `Date` objects but with different field structures (`startDate/endDate` vs `schedule.date`)
- **Location Structure**: Different venue information structures - conference.ts has detailed `location` object with address nesting, dataModels.ts has simpler `venue` object
- **Registration Structure**: conference.ts has complex nested `registration` object with fees, capacity, and waitlist management; dataModels.ts has simpler registration fields
- **Enhanced Features**: conference.ts includes agenda, speakers, FAQs, venue details, social media, and theming; dataModels.ts lacks these enhanced structures
- **Metadata Patterns**: Different metadata field naming and structure between the two models

**Field Mapping Conflicts**:
```typescript
// /src/types/conference.ts
interface Conference {
  schedule: {
    date: Date;
    startTime: string;
    endTime: string;
    timezone: string;
  };
  location: {
    venue: string;
    address: { street, city, state, zipCode };
    virtualOption?: boolean;
    virtualLink?: string;
  };
}

// /src/types/dataModels.ts  
interface Conference {
  startDate: Date;
  endDate: Date;
  timezone: string;
  isVirtual: boolean;
  virtualUrl?: string;
  venue?: {
    name: string;
    address: string; // Single string vs nested object
    city: string;
    state: string;
    zipCode: string;
  };
}
```

### Repository Pattern Requirements

[Source: docs/architecture/core-backend-components.md#data-access-layer]

**Repository Structure for Conference Data**:
- All database operations must use repository pattern in `/src/lib/conference.ts`
- Repository methods must include read, write, and business logic operations
- Zod schemas must be used for all data validation at the repository level
- Error handling must use AppError and ValidationError classes
- DTOs must separate create, update, and response operations

**Required Repository Methods**:
```typescript
export const conferenceRepository = {
  // Read operations
  async findById(id: string): Promise<Conference | null>
  async findByYear(year: number): Promise<Conference | null>
  async listActive(limit?: number): Promise<Conference[]>
  
  // Write operations  
  async create(data: CreateConferenceDto): Promise<Conference>
  async update(id: string, data: UpdateConferenceDto): Promise<Conference>
  async archive(id: string): Promise<void>
  
  // Business logic operations
  async processRegistration(registration: ConferenceRegistration): Promise<ProcessResult>
  async updateRegistrationCount(conferenceId: string): Promise<void>
}
```

### Zod Schema Implementation Requirements

[Source: docs/architecture/core-backend-components.md#data-transfer-objects-dtos]

**Schema Validation Architecture**:
- Create separate DTOs for create, update, and response operations
- Transform between Firestore documents and DTOs in repository layer
- Use proper date validation and coercion for Firestore timestamp fields
- Implement nested object validation for complex structures like venue details

**Required Zod Schemas**:
```typescript
// Core conference schema with proper date handling
export const ConferenceSchema = z.object({
  id: z.string(),
  title: z.string().min(1, "Conference title is required"),
  description: z.string().min(1, "Conference description is required"),
  year: z.number().int().min(2020).max(2030),
  
  // Unified date/time structure
  schedule: z.object({
    date: z.date(),
    startTime: z.string().regex(/^\d{2}:\d{2}$/, "Time must be in HH:MM format"),
    endTime: z.string().regex(/^\d{2}:\d{2}$/, "Time must be in HH:MM format"),
    timezone: z.string().min(1, "Timezone is required")
  }),
  
  // Unified location structure
  location: z.object({
    venue: z.string().min(1, "Venue name is required"),
    address: z.object({
      street: z.string(),
      city: z.string(),
      state: z.string(),
      zipCode: z.string()
    }),
    virtualOption: z.boolean().optional(),
    virtualLink: z.string().url().optional()
  }),
  
  // Enhanced registration structure
  registration: z.object({
    isOpen: z.boolean(),
    openDate: z.date(),
    closeDate: z.date(),
    capacity: z.number().int().positive(),
    currentCount: z.number().int().min(0),
    waitlistEnabled: z.boolean(),
    fees: z.object({
      member: z.number().min(0),
      nonMember: z.number().min(0),
      student: z.number().min(0),
      earlyBird: z.object({
        amount: z.number().min(0),
        deadline: z.date()
      }).optional()
    })
  })
});

// Create and Update DTOs
export const CreateConferenceSchema = ConferenceSchema.omit({ id: true, metadata: true });
export const UpdateConferenceSchema = ConferenceSchema.partial().omit({ id: true });
```

### Data Migration Strategy

[Source: docs/architecture/13-v1-data-migration-strategy.md]

**Migration Requirements**:
- Support importing V1 conference data with full fee structure
- Preserve existing conference registration data during schema consolidation
- Validate all migrated data against new unified schema
- Provide rollback capability for production deployments

**Migration Utilities Location**: `/src/lib/v1DataImport.ts`
- CSV parsing utilities for legacy data
- Data transformation functions to map old schema to new unified schema  
- Firestore batch import capabilities with progress tracking
- Validation and error reporting for migration process

### Error Handling Implementation

[Source: docs/architecture/core-backend-components.md#error-handling-strategy]

**Required Error Classes**:
```typescript
export class ConferenceValidationError extends ValidationError {
  constructor(message: string, errors: ZodError, conferenceId?: string) {
    super(message, errors);
    this.conferenceId = conferenceId;
  }
}

export class ConferenceNotFoundError extends AppError {
  constructor(conferenceId: string) {
    super('CONFERENCE_NOT_FOUND', `Conference ${conferenceId} not found`, 404);
  }
}
```

**Error Response Format**:
```json
{
  "error": {
    "code": "CONFERENCE_VALIDATION_ERROR",
    "message": "Invalid conference data",
    "details": {
      "fields": {
        "schedule.date": "Date must be in the future",
        "registration.fees.member": "Member fee must be non-negative"
      }
    }
  }
}
```

### Performance and Caching Requirements

[Source: docs/architecture/core-backend-components.md#performance-optimization]

**Caching Strategy for Conference Data**:
- Conference content: 1 minute cache (CACHE_TIMES.CONFERENCE = 60)
- Conference registration data: No caching due to real-time updates
- Conference metadata: 5 minutes cache for speaker/agenda data

**Database Query Optimization**:
- Use Firestore composite indexes for conference year and status queries
- Implement pagination for conference registrant lists
- Denormalize frequently accessed conference data (title, year) in registrant documents
- Batch operations for conference session and speaker updates

### Integration Points

**Files Requiring Updates**:
- `/src/types/conference.ts` - Consolidate into unified interface
- `/src/types/dataModels.ts` - Remove duplicate Conference interface  
- `/src/lib/conference.ts` - Update all repository methods with validation
- `/src/app/conference/page.tsx` - Update to use unified interface
- All conference-related components in `/src/components/Conference*.tsx`
- Conference registration form components and validation utilities

**API Endpoints Requiring Validation**:
- Conference creation and update endpoints
- Conference registration processing
- Conference data retrieval with proper validation
- Batch operations for conference sessions and speakers

## Testing

**Test File Locations**: Conference schema and validation tests will be implemented in `/src/lib/__tests__/conference/` directory with integration into existing Jest/React Testing Library setup

**Testing Framework Integration**:
- **Schema Validation Tests**: Comprehensive Zod schema testing with valid/invalid data scenarios
- **Repository Integration Tests**: Database operations with schema validation using mock Firestore
- **Migration Testing**: Data transformation and validation during migration process
- **Error Handling Tests**: ValidationError and ConferenceValidationError response validation

**Specific Testing Requirements**:
- Validate schema coercion for Firestore timestamp to Date object conversion
- Test partial update validation with UpdateConferenceSchema  
- Verify nested object validation for venue details, accessibility info, and parking info
- Test registration capacity validation and waitlist management
- Validate conference session time range checks and speaker reference validation
- Test error message clarity and field-specific validation guidance

**Schema Validation Testing Standards**:
- **Valid Data Testing**: Verify schema accepts properly formatted conference data with all required fields
- **Invalid Data Testing**: Test schema rejection of malformed data with proper error messages
- **Edge Case Testing**: Test boundary conditions for dates, numbers, and array lengths
- **Coercion Testing**: Verify proper transformation of string dates, numeric strings, and boolean values
- **Nested Object Testing**: Validate complex nested structures like venue details and registration fees
- **Migration Testing**: Verify successful transformation of legacy data structures to unified schema

**Integration Testing for Repository Methods**:
- **Create Operations**: Test conference creation with schema validation and proper error handling
- **Update Operations**: Test partial updates with proper validation and merge logic
- **Query Operations**: Test data retrieval with output validation and schema compliance
- **Error Scenarios**: Test database errors, validation failures, and recovery mechanisms
- **Performance Testing**: Verify schema validation performance with large conference datasets
- **Concurrent Operations**: Test schema validation with multiple simultaneous conference operations

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-07-29 | 1.0 | Initial story creation for conference data model unification and runtime validation | SM Agent |